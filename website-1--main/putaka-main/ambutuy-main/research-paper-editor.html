<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Research Paper Editor</title>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; font-size: 12pt; }
        .container { max-width: 900px; margin: auto; background: transparent; padding: 20px; border-radius: 8px; }
        h2 { margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        #toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        select, button, input[type="range"] { padding: 8px; font-size: 12pt; }
        .line-spacing-control { display: flex; align-items: center; gap: 8px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background: white; margin-left: 12px; }
        .line-spacing-control label { font-size: 13px; color: #444; font-weight: 500; white-space: nowrap; }
        .line-spacing-number { font-size: 14px; font-weight: bold; color: #007bff; min-width: 35px; text-align: center; }
        .line-spacing-buttons { display: flex; gap: 2px; }
        .line-spacing-buttons button { padding: 2px 8px; font-size: 16px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 3px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .line-spacing-buttons button:hover { background: #f0f0f0; }
        #editor { height: auto; min-height: 400px; }
        .done-btn { margin-top: 15px; background: #007bff; color: white; border: none; cursor: pointer; padding: 10px 15px; border-radius: 5px; }
        .done-btn:hover { background: #0056b3; }
        .ql-editor { font-family: "Bookman Old Style", serif; font-size: 12pt; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 1in; box-sizing: border-box; background-color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.12); border-radius: 4px; position: relative; }
        .ql-editor p { margin: 0; }
        #ruler { width: 210mm; height: 24px; background: #f0f0f0; position: relative; margin: 0 auto; border: 1px solid #ccc; box-sizing: border-box; }
        .margin-handle { position: absolute; width: 4px; height: 20px; background: #007bff; cursor: ew-resize; top: 0; z-index: 4; }
        .margin-label { position: absolute; bottom: calc(100% + 6px); transform: translateX(-50%); background: rgba(0,0,0,0.75); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 120ms; }
        .margin-label.visible { opacity: 1; }
        #ruler .ticks { position: absolute; left: 0; top: 0; right: 0; bottom: 0; pointer-events: none; z-index: 1; }
        .tick { position: absolute; bottom: 2px; width: 1px; background: #444; }
        .tick.short { height: 6px; }
        .tick.medium { height: 10px; }
        .tick.long { height: 14px; background: #000; }
        .tick-label { position: absolute; bottom: 18px; transform: translateX(-50%); font-size: 10px; color: #333; pointer-events: none; z-index: 2; }
        .margin-guide { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(0,0,0,0.28); z-index: 3; pointer-events: none; }
        .reference-panel { width: 350px; background: white; border-left: 1px solid #ddd; position: fixed; right: 0; top: 0; bottom: 0; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 50; }
        .reference-panel.collapsed { transform: translateX(100%); }
        .show-panel-btn {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-radius: 4px 0 0 4px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 12px;
            font-weight: 600;
            z-index: 49;
            transition: opacity 0.3s ease;
        }
        .show-panel-btn.hidden { opacity: 0; pointer-events: none; }
        .show-panel-btn:hover { background: #0056b3; }
        .reference-header { padding: 16px; background: #007bff; color: white; display: flex; justify-content: space-between; align-items: center; }
        .reference-header h3 { font-size: 14px; margin: 0; }
        .toggle-panel-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; }
        .reference-content { flex: 1; overflow-y: auto; padding: 16px; }
        .reference-item { margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff; border-radius: 4px; font-size: 13px; line-height: 1.4; }
        .reference-actions { padding: 12px 16px; border-top: 1px solid #eee; }
        .reference-actions button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .reference-actions button:hover { background: #218838; }
        .empty-references { text-align: center; color: #999; padding: 20px; }
        .context-menu { position: fixed; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; z-index: 10000; display: none; min-width: 200px; }
        .context-menu.active { display: block; }
        .context-menu-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; }
        .context-menu-item:hover { background: #f0f0f0; }
        .research-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .research-modal.active { display: flex; }
        .research-modal-content { background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .research-modal-header { padding: 16px; background: #007bff; color: white; display: flex; justify-content: space-between; align-items: center; }
        .research-modal-header h3 { margin: 0; font-size: 16px; }
        .close-modal { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .research-modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .search-info { background: #e7f3ff; padding: 12px; border-radius: 4px; margin-bottom: 14px; }
        .research-card { border: 1px solid #ddd; border-radius: 6px; padding: 12px; background: #f9f9f9; margin-bottom: 12px; }
        .research-card h4 { color: #007bff; margin: 0 0 8px 0; font-size: 14px; }
        .research-card p { color: #555; margin: 0 0 8px 0; font-size: 13px; line-height: 1.4; }
        .research-card .citation { background: white; padding: 8px; border-left: 3px solid #007bff; font-size: 12px; color: #666; margin-top: 6px; }
        .research-card button { background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .research-card button:hover { background: #218838; }
    </style>
</head>
<body>
<div class="container">
    <h2>Research Paper Editor</h2>
    <div id="toolbar" class="ql-toolbar ql-snow">
        <span class="ql-formats">
            <button class="ql-bold" title="Bold"></button>
            <button class="ql-italic" title="Italic"></button>
            <select class="ql-background" title="Highlight"></select>
        </span>
        <span class="ql-formats">
            <button class="ql-list" value="ordered" title="Numbered list"></button>
            <button class="ql-list" value="bullet" title="Bulleted list"></button>
        </span>
        <span class="ql-formats">
            <select class="ql-align" title="Alignment"></select>
        </span>
        <span class="ql-formats">
            <button class="ql-image" title="Insert image"></button>
            <button class="ql-clean" title="Remove formatting"></button>
        </span>
        <div class="line-spacing-control">
            <label>Line Spacing:</label>
            <span class="line-spacing-number" id="lineSpacingDisplay">1.5</span>
            <div class="line-spacing-buttons">
                <button onclick="decreaseLineSpacing()" title="Decrease">‚àí</button>
                <button onclick="increaseLineSpacing()" title="Increase">+</button>
            </div>
        </div>
    </div>
    <div id="ruler">
        <div class="margin-handle left" id="leftHandle"></div>
        <div class="margin-label left" id="leftLabel"></div>
        <div class="ticks" id="ticks"></div>
        <div class="margin-handle right" id="rightHandle"></div>
        <div class="margin-label right" id="rightLabel"></div>
    </div>
    <div id="editor"></div>
    <button class="done-btn" onclick="submitPaper()">Done</button>
</div>

<div class="reference-panel" id="referencePanel">
    <div class="reference-header">
        <h3>References (APA Format)</h3>
        <button class="toggle-panel-btn" onclick="toggleReferencePanel()">Hide</button>
    </div>
    <div class="reference-content" id="referenceContent">
        <div class="empty-references">
            <p>üìö No references yet</p>
            <p style="font-size: 12px; margin-top: 10px;">Right-click on text and select "Find Research" to add references</p>
        </div>
    </div>
    <div class="reference-actions">
        <button onclick="copyAllReferences()">üìã Copy All References</button>
    </div>
</div>

<button class="show-panel-btn" id="showPanelBtn" onclick="toggleReferencePanel()">References</button>

<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="findResearch()">
        <span>üîç</span>
        <span>Find Research & Literature</span>
    </div>
</div>

<div class="research-modal" id="researchModal">
    <div class="research-modal-content">
        <div class="research-modal-header">
            <h3>Research Assistant</h3>
            <button class="close-modal" onclick="closeResearchModal()">√ó</button>
        </div>
        <div class="research-modal-body" id="researchModalBody">
            <div class="loading"><p>üîç Searching for relevant research...</p></div>
        </div>
    </div>
</div>

<script>
let quill;
let currentLineSpacing = 1.5;
const spacingOptions = [1.0, 1.15, 1.5, 2.0, 2.5, 3.0];
let selectedText = '';
let references = [];
let currentSearchResults = [];
let leftGuide = null;
let rightGuide = null;

// Initialize Quill editor
window.addEventListener('load', () => {
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: '#toolbar'
        }
    });

    const initialTemplate = `<h1 style="text-align:center; font-size:20pt; margin-bottom:12px;">Your Paper Title</h1><h3 style="margin-top:6px;">Abstract</h3><p>Please provide a concise abstract summarizing your paper.</p><h3 style="margin-top:12px;">Introduction</h3><p>Start writing your introduction here...</p>`;
    quill.clipboard.dangerouslyPasteHTML(initialTemplate);

    initRuler();
    applyLineSpacing(1.5);
    setupEditorBindings();
});

function setupEditorBindings() {
    const editor = quill.root;
    
    // Monitor new paragraphs
    const observer = new MutationObserver(() => {
        const allParagraphs = editor.querySelectorAll('p');
        allParagraphs.forEach(p => {
            if (!p.style.lineHeight) {
                p.style.lineHeight = currentLineSpacing;
            }
        });
    });
    observer.observe(editor, { childList: true, subtree: true });

    // Context menu
    editor.addEventListener('contextmenu', e => {
        e.preventDefault();
        const selection = quill.getSelection();
        if (selection && selection.length > 0) {
            selectedText = quill.getText(selection.index, selection.length).trim();
            if (selectedText.length > 0) {
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.classList.add('active');
            }
        }
    });

    document.addEventListener('click', () => {
        document.getElementById('contextMenu').classList.remove('active');
    });
}

function initRuler() {
    const ruler = document.getElementById('ruler');
    const leftHandle = document.getElementById('leftHandle');
    const rightHandle = document.getElementById('rightHandle');
    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');

    generateRulerTicks();
    
    leftHandle.style.left = '96px';
    rightHandle.style.left = (ruler.offsetWidth - 96) + 'px';

    ensureGuides();
    updateMargins();

    let isDragging = false;
    let currentHandle = null;

    leftHandle.addEventListener('mousedown', e => {
        e.preventDefault();
        isDragging = true;
        currentHandle = 'left';
        leftLabel.classList.add('visible');
    });

    rightHandle.addEventListener('mousedown', e => {
        e.preventDefault();
        isDragging = true;
        currentHandle = 'right';
        rightLabel.classList.add('visible');
    });

    document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const rulerRect = ruler.getBoundingClientRect();
        let x = Math.max(0, Math.min(e.clientX - rulerRect.left, ruler.offsetWidth));
        
        if (currentHandle === 'left') {
            x = Math.min(x, parseFloat(rightHandle.style.left) - 10);
            leftHandle.style.left = x + 'px';
        } else if (currentHandle === 'right') {
            x = Math.max(x, parseFloat(leftHandle.style.left) + 10);
            rightHandle.style.left = x + 'px';
        }
        updateMargins();
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            currentHandle = null;
            leftLabel.classList.remove('visible');
            rightLabel.classList.remove('visible');
        }
    });
}

function generateRulerTicks() {
    const ticksContainer = document.getElementById('ticks');
    const ruler = document.getElementById('ruler');
    ticksContainer.innerHTML = '';
    
    const pxPerInch = 96;
    const subdivisions = 8;
    const totalPx = ruler.offsetWidth;
    const totalInches = Math.ceil(totalPx / pxPerInch);
    
    for (let i = 0; i <= totalInches * subdivisions; i++) {
        const posPx = i * (pxPerInch / subdivisions);
        const tick = document.createElement('div');
        tick.className = 'tick';
        
        if (i % subdivisions === 0) {
            tick.classList.add('long');
            const label = document.createElement('div');
            label.className = 'tick-label';
            label.textContent = (i / subdivisions) + '"';
            label.style.left = posPx + 'px';
            ticksContainer.appendChild(label);
        } else if (i % 4 === 0) {
            tick.classList.add('medium');
        } else {
            tick.classList.add('short');
        }
        
        tick.style.left = posPx + 'px';
        ticksContainer.appendChild(tick);
    }
}

function ensureGuides() {
    const editor = quill.root;
    leftGuide = editor.querySelector('#leftGuide');
    rightGuide = editor.querySelector('#rightGuide');
    
    if (!leftGuide) {
        leftGuide = document.createElement('div');
        leftGuide.id = 'leftGuide';
        leftGuide.className = 'margin-guide';
        leftGuide.style.left = '96px';
        editor.appendChild(leftGuide);
    }
    
    if (!rightGuide) {
        rightGuide = document.createElement('div');
        rightGuide.id = 'rightGuide';
        rightGuide.className = 'margin-guide';
        rightGuide.style.right = '96px';
        editor.appendChild(rightGuide);
    }
}

function updateMargins() {
    const ruler = document.getElementById('ruler');
    const leftHandle = document.getElementById('leftHandle');
    const rightHandle = document.getElementById('rightHandle');
    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');
    
    const pxPerInch = 96;
    const rulerWidth = ruler.offsetWidth;
    
    const leftPx = parseFloat(leftHandle.style.left);
    const leftInch = leftPx / pxPerInch;
    
    const rightPx = parseFloat(rightHandle.style.left);
    const rightInch = (rulerWidth - rightPx) / pxPerInch;
    
    const editor = quill.root;
    editor.style.paddingLeft = leftInch + 'in';
    editor.style.paddingRight = rightInch + 'in';
    
    leftLabel.textContent = leftInch.toFixed(2) + '"';
    rightLabel.textContent = rightInch.toFixed(2) + '"';
    leftLabel.style.left = leftPx + 'px';
    rightLabel.style.left = rightPx + 'px';
    
    ensureGuides();
    leftGuide.style.left = (leftPx / pxPerInch) + 'in';
    rightGuide.style.right = ((rulerWidth - rightPx) / pxPerInch) + 'in';
}

function applyLineSpacing(value) {
    currentLineSpacing = value;
    document.getElementById('lineSpacingDisplay').textContent = value.toFixed(2);
    const paragraphs = quill.root.querySelectorAll('p');
    paragraphs.forEach(p => p.style.lineHeight = value);
}

function increaseLineSpacing() {
    const i = spacingOptions.indexOf(currentLineSpacing);
    if (i < spacingOptions.length - 1) {
        applyLineSpacing(spacingOptions[i + 1]);
    }
}

function decreaseLineSpacing() {
    const i = spacingOptions.indexOf(currentLineSpacing);
    if (i > 0) {
        applyLineSpacing(spacingOptions[i - 1]);
    }
}

function findResearch() {
    if (!selectedText) return;
    
    const modal = document.getElementById('researchModal');
    const modalBody = document.getElementById('researchModalBody');
    
    modal.classList.add('active');
    modalBody.innerHTML = `<div class="search-info"><strong>Searching for:</strong> "${selectedText}"</div><div class="loading"><p>üîç Searching academic databases...</p></div>`;
    
    performAcademicSearch(selectedText);
}

async function performAcademicSearch(query) {
    const modalBody = document.getElementById('researchModalBody');

    try {
        // Call the local proxy which will call Anthropic securely from the server
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
        });

        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || `Server error: ${response.status}`);
        }

        const data = await response.json();
        let papers = [];

        if (Array.isArray(data.papers) && data.papers.length) {
            papers = data.papers;
        } else if (data.raw && typeof data.raw === 'string') {
            // Try to parse JSON from raw text
            let cleaned = data.raw.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            try {
                papers = JSON.parse(cleaned);
            } catch (e) {
                console.error('Failed to parse JSON from raw response, falling back to simple extraction:', e);
                const lines = data.raw.split('\n');
                let currentPaper = {};
                papers = [];
                for (const line of lines) {
                    if (line.includes('"title"') || line.includes('Title:')) {
                        if (Object.keys(currentPaper).length > 0) { papers.push({...currentPaper}); currentPaper = {}; }
                        currentPaper.title = line.split(':')[1]?.replace(/[",]/g, '').trim() || 'Untitled';
                    }
                    if (line.includes('"authors"') || line.includes('Authors:')) {
                        currentPaper.authors = line.split(':')[1]?.replace(/[",]/g, '').trim() || 'Unknown';
                    }
                    if (line.includes('"year"') || line.includes('Year:')) {
                        currentPaper.year = line.split(':')[1]?.replace(/[",]/g, '').trim() || new Date().getFullYear().toString();
                    }
                    if (line.includes('"journal"') || line.includes('Journal:')) {
                        currentPaper.journal = line.split(':')[1]?.replace(/[",]/g, '').trim() || 'Unknown Journal';
                    }
                    if (line.includes('"summary"') || line.includes('Summary:')) {
                        currentPaper.summary = line.split(':')[1]?.replace(/[",]/g, '').trim() || 'No summary available';
                    }
                    if (line.includes('"doi"') || line.includes('DOI:')) {
                        currentPaper.doi = line.split(':')[1]?.replace(/[",]/g, '').trim() || '';
                    }
                }
                if (Object.keys(currentPaper).length > 0) papers.push(currentPaper);
            }
        }

        // Normalize
        papers = papers.map(p => ({
            title: p.title || 'Research Paper',
            authors: p.authors || 'Various Authors',
            year: p.year || new Date().getFullYear().toString(),
            journal: p.journal || 'Academic Journal',
            summary: p.summary || 'Summary not available',
            doi: p.doi || '',
            volume: p.volume || '',
            issue: p.issue || '',
            pages: p.pages || ''
        }));

        if (papers.length === 0) {
            throw new Error('No papers found in response');
        }

        currentSearchResults = papers;
        displayResearchResults(papers);

    } catch (error) {
        console.error('Research search error:', error);
        modalBody.innerHTML = `
            <div class="search-info" style="background:#fee;color:#900;">
                <strong>‚ö†Ô∏è Search Error</strong>
                <p style="margin-top:8px;">Failed to fetch research papers. Error: ${error.message}</p>
                <p style="margin-top:8px;font-size:12px;">This feature requires the server to be running with ANTHROPIC_API_KEY set in .env.</p>
            </div>
            <div style="padding:20px;text-align:center;">
                <button onclick="closeResearchModal()" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;">Close</button>
            </div>
        `;
    }
}

function displayResearchResults(papers) {
    const modalBody = document.getElementById('researchModalBody');
    
    if (!papers || papers.length === 0) {
        modalBody.innerHTML = `<div class="search-info"><strong>Search for:</strong> "${selectedText}"</div><div style="padding:40px;text-align:center;color:#666;">No papers found.<br><button onclick="closeResearchModal()" style="margin-top:20px;padding:8px 12px;background:#007bff;color:#fff;border:none;border-radius:4px;">Close</button></div>`;
        return;
    }
    
    modalBody.innerHTML = `<div class="search-info"><strong>Found ${papers.length} paper(s) for:</strong> "${selectedText}"</div>` + 
        papers.map((p, i) => `
            <div class="research-card">
                <h4>${p.title}</h4>
                <p>${p.summary}</p>
                <div class="citation">${generateAPACitation(p)}</div>
                <button onclick="insertResearch(${i})">‚úì Insert This Research</button>
            </div>
        `).join('');
}

function generateAPACitation(p) {
    let c = '';
    if (p.authors) c += p.authors;
    if (p.year) c += ` (${p.year}).`;
    if (p.title) c += ` ${p.title}.`;
    if (p.journal) c += ` <em>${p.journal}</em>`;
    if (p.volume) c += `, ${p.volume}`;
    if (p.issue) c += `(${p.issue})`;
    if (p.pages) c += `, ${p.pages}.`;
    if (p.doi) c += ` ${p.doi}`;
    return c;
}

function insertResearch(index) {
    const paper = currentSearchResults[index];
    if (!paper) {
        alert('Error: Research data not found');
        return;
    }
    
    let inTextCitation = '';
    if (paper.authors && paper.year) {
        const firstAuthor = paper.authors.split(',')[0].trim();
        const authorCount = (paper.authors.match(/,/g) || []).length + 1;
        
        if (authorCount === 1) {
            inTextCitation = `(${firstAuthor}, ${paper.year})`;
        } else if (authorCount === 2) {
            const authors = paper.authors.split('&').map(a => a.split(',')[0].trim());
            inTextCitation = `(${authors.join(' & ')}, ${paper.year})`;
        } else {
            inTextCitation = `(${firstAuthor} et al., ${paper.year})`;
        }
    }
    
    const researchText = `\n\n${paper.summary} ${inTextCitation}`;
    const selection = quill.getSelection();
    
    if (selection) {
        quill.insertText(selection.index + selection.length, researchText);
    } else {
        quill.insertText(quill.getLength(), researchText);
    }
    
    addReference(generateAPACitation(paper));
    closeResearchModal();
    alert('‚úì Research added!\n\nThe reference has been added to your reference list in APA format.');
}

function addReference(citation) {
    if (!references.includes(citation)) {
        references.push(citation);
        references.sort();
        updateReferencePanel();
    }
}

function updateReferencePanel() {
    const content = document.getElementById('referenceContent');
    
    if (references.length === 0) {
        content.innerHTML = `<div class="empty-references"><p>üìö No references yet</p><p style="font-size:12px;margin-top:10px;">Right-click on text and select "Find Research"</p></div>`;
    } else {
        content.innerHTML = references.map(ref => `<div class="reference-item">${ref}</div>`).join('');
    }
}

function closeResearchModal() {
    document.getElementById('researchModal').classList.remove('active');
}

function toggleReferencePanel() {
    const panel = document.getElementById('referencePanel');
    const showBtn = document.getElementById('showPanelBtn');
    
    panel.classList.toggle('collapsed');
    
    const toggleBtn = panel.querySelector('.toggle-panel-btn');
    toggleBtn.textContent = panel.classList.contains('collapsed') ? 'Show' : 'Hide';
    showBtn.classList.toggle('hidden', !panel.classList.contains('collapsed'));
}

function copyAllReferences() {
    if (references.length === 0) {
        alert('No references to copy');
        return;
    }

    const text = references.join('\n\n');
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert('References copied to clipboard');
        }).catch(err => {
            alert('Failed to copy references: ' + (err.message || err));
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try {
            document.execCommand('copy');
            alert('References copied to clipboard');
        } catch (e) {
            alert('Copy failed');
        }
        ta.remove();
    }
}

function submitPaper() {
    // Export current editor content as an HTML file
    const rawHtml = quill.root.innerHTML;
    const titleText = (quill.getText(0, 100).split('\n')[0] || 'paper').trim();
    const filename = titleText.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase() + '.html';
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>${titleText}</title></head><body>${rawHtml}</body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    alert('‚úì Paper exported as ' + filename);
}